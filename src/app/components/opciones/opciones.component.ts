import { Component, OnInit, OnDestroy, inject, ChangeDetectorRef } from '@angular/core';
import { Router } from '@angular/router';
import { Subscription } from 'rxjs';
import { UserStateService, PerfilUsuario } from '../../services/user-state.service';

// Importar el m√≥dulo de enrutamiento
@Component({
  selector: 'app-opciones',
  templateUrl: './opciones.component.html',
  styleUrls: ['./opciones.component.css']
})
export class OpcionesComponent implements OnInit, OnDestroy {

  // ‚úÖ Inyecci√≥n de dependencias con inject() - tipado expl√≠cito
  private router: Router = inject(Router);
  private userStateService: UserStateService = inject(UserStateService);
  private cdr: ChangeDetectorRef = inject(ChangeDetectorRef);

  // ‚úÖ Propiedades para el usuario
  perfilUsuario: PerfilUsuario | null = null;
  private userSubscription: Subscription = new Subscription();

  // ‚úÖ Propiedades de la interfaz
  showUserMenu = false;
  showSidebar = true;

  ngOnInit(): void {
    console.log('üöÄ OpcionesComponent iniciando...');

    // ‚úÖ Debug inicial antes de suscripci√≥n
    console.log('üîç Estado inicial en localStorage:');
    console.log('user_data:', localStorage.getItem('user_data'));
    console.log('access_token:', localStorage.getItem('access_token') ? 'EXISTS' : 'NOT_FOUND');

    // ‚úÖ Debug del usuario actual
    const usuarioActual = this.userStateService.getUsuarioActual();
    console.log('üë§ Usuario actual del servicio:', usuarioActual);

    // ‚úÖ IMPORTANTE: Procesar usuario actual ANTES de suscripci√≥n
    if (usuarioActual) {
      this.perfilUsuario = this.userStateService.getPerfilUsuario();
      console.log('‚úÖ Perfil inicial cargado:', this.perfilUsuario);
    }

    // ‚úÖ Suscribirse a cambios en el usuario
    this.userSubscription = this.userStateService.usuarioActual$.subscribe(usuario => {
      console.log('üì° Observable usuarioActual$ emiti√≥:', usuario);

      if (usuario) {
        this.perfilUsuario = this.userStateService.getPerfilUsuario();
        console.log('‚úÖ Perfil de usuario cargado en opciones:', this.perfilUsuario);
      } else {
        this.perfilUsuario = null;
        console.log('‚ö†Ô∏è No hay usuario autenticado - observable emiti√≥ null');
      }

      // Forzar detecci√≥n de cambios
      this.cdr.detectChanges();
    });

    // ‚úÖ Debug info completo
    const debugInfo = this.userStateService.getDebugInfo();
    console.log('üîç Debug info completo:', debugInfo);
  }

  ngOnDestroy(): void {
    // ‚úÖ Limpiar suscripciones
    this.userSubscription.unsubscribe();
  }

  // ‚úÖ M√©todos de navegaci√≥n
  irAlLogin() {
    this.router.navigate(['/login']);
  }

  irAInicio() {
    this.router.navigate(['/']);
  }

  // ‚úÖ M√©todos de la interfaz
  toggleUserMenu() {
    this.showUserMenu = !this.showUserMenu;
  }

  toggleSidebar() {
    this.showSidebar = !this.showSidebar;
  }

  // ‚úÖ M√©todo para cerrar sesi√≥n mejorado con confirmaci√≥n
  cerrarSesion(): void {
    console.log('üö™ Solicitando cerrar sesi√≥n...');

    // Mostrar confirmaci√≥n
    const confirmar = confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?');

    if (!confirmar) {
      console.log('‚ùå Cierre de sesi√≥n cancelado por el usuario');
      return;
    }

    console.log('‚úÖ Cerrando sesi√≥n confirmado, procediendo...');

    try {
      // 1. Limpiar datos del usuario del servicio y localStorage
      this.userStateService.limpiarUsuario();

      // 2. Limpiar variables locales
      this.perfilUsuario = null;

      // 3. Forzar actualizaci√≥n de la vista
      this.cdr.detectChanges();

      console.log('‚úÖ Datos de sesi√≥n limpiados correctamente');
      console.log('üîÑ Redirigiendo a login...');

      // 4. Navegar al login
      this.router.navigate(['/login'], {
        replaceUrl: true // Esto reemplaza la entrada actual en el historial
      });

      // 5. Opcional: mostrar mensaje de despedida
      setTimeout(() => {
        console.log('üëã Sesi√≥n cerrada exitosamente');
      }, 500);

    } catch (error) {
      console.error('‚ùå Error al cerrar sesi√≥n:', error);

      // Fallback: navegar al login aunque haya un error
      this.router.navigate(['/login'], { replaceUrl: true });
    }
  }

  // ‚úÖ M√©todo para cerrar sesi√≥n sin confirmaci√≥n (para uso interno)
  cerrarSesionSilencioso(): void {
    console.log('üîá Cerrando sesi√≥n silenciosamente...');

    try {
      // 1. Limpiar datos del usuario del servicio y localStorage
      this.userStateService.limpiarUsuario();

      // 2. Limpiar variables locales
      this.perfilUsuario = null;

      // 3. Forzar actualizaci√≥n de la vista
      this.cdr.detectChanges();

      console.log('‚úÖ Sesi√≥n cerrada silenciosamente');

      // 4. Navegar al login
      this.router.navigate(['/login'], {
        replaceUrl: true,
        queryParams: { mensaje: 'sesion_expirada' } // Opcional: pasar info del motivo
      });

    } catch (error) {
      console.error('‚ùå Error al cerrar sesi√≥n silenciosamente:', error);
      this.router.navigate(['/login'], { replaceUrl: true });
    }
  }

  // ‚úÖ Getter para facilitar el uso en el template
  get nombreUsuario(): string {
    const nombre = this.perfilUsuario?.nombreCompleto || 'Usuario';
    console.log('üë§ Getter nombreUsuario llamado:', nombre);
    return nombre;
  }

  get rolUsuario(): string {
    const rol = this.perfilUsuario?.rolCorto || 'Sin rol';
    console.log('üè∑Ô∏è Getter rolUsuario llamado:', rol);
    return rol;
  }

  get avatarUsuario(): string {
    return this.perfilUsuario?.avatar || 'assets/images/user_admin.png';
  }

  // ‚úÖ Informaci√≥n adicional para el sidebar
  get iniciales(): string {
    const iniciales = this.perfilUsuario?.iniciales || 'U';
    console.log('üî§ Getter iniciales llamado:', iniciales);
    return iniciales;
  }

  get isAuthenticated(): boolean {
    const authenticated = this.userStateService.isAuthenticated();
    console.log('üîê Getter isAuthenticated llamado:', authenticated);
    return authenticated;
  }

  get statusColor(): string {
    const color = this.isAuthenticated ? 'text-green-500' : 'text-red-500';
    console.log('üé® Getter statusColor llamado:', color);
    return color;
  }

  get statusText(): string {
    const text = this.isAuthenticated ? 'Conectado' : 'Desconectado';
    console.log('üì∂ Getter statusText llamado:', text);
    return text;
  }

  // ‚úÖ M√âTODO TEMPORAL PARA DEBUG
  simularDatosUsuario(): void {
    console.log('üß™ Simulando datos de usuario...');

    // Limpiar primero
    localStorage.clear();

    // Simular login exitoso
    this.userStateService.simularUsuarioEnLocalStorage();

    // Forzar actualizaci√≥n del componente
    setTimeout(() => {
      const debugInfo = this.userStateService.getDebugInfo();
      console.log('üîç Estado despu√©s de simulaci√≥n:', debugInfo);

      this.perfilUsuario = this.userStateService.getPerfilUsuario();
      console.log('üë§ Perfil actualizado:', this.perfilUsuario);

      // Forzar detecci√≥n de cambios
      this.cdr.detectChanges();
    }, 100);
  }

  // M√©todo adicional para limpiar datos
  limpiarDatos(): void {
    console.log('üßπ Limpiando datos...');

    // Mostrar estado antes de limpiar
    const tokenAntes = localStorage.getItem('access_token');
    const userDataAntes = localStorage.getItem('user_data');

    this.userStateService.limpiarUsuario();
    this.perfilUsuario = null;

    // Mostrar estado despu√©s de limpiar
    const tokenDespues = localStorage.getItem('access_token');
    const userDataDespues = localStorage.getItem('user_data');

    let mensaje = 'üßπ DATOS LIMPIADOS:\n\n';
    mensaje += `ANTES:\n`;
    mensaje += `- Token: ${!!tokenAntes}\n`;
    mensaje += `- User data: ${!!userDataAntes}\n\n`;
    mensaje += `DESPU√âS:\n`;
    mensaje += `- Token: ${!!tokenDespues}\n`;
    mensaje += `- User data: ${!!userDataDespues}\n\n`;
    mensaje += 'Los datos han sido eliminados del localStorage';

    alert(mensaje);
  }

  // M√©todo para forzar recarga
  recargarDatos(): void {
    console.log('üîÑ Forzando recarga desde localStorage...');
    this.userStateService.recargarDesdeLocalStorage();
  }

  // M√©todo adicional para verificar localStorage
  verificarLocalStorage(): void {
    console.log('üîç === VERIFICACI√ìN DE LOCALSTORAGE ===');
    console.log('access_token:', localStorage.getItem('access_token'));
    console.log('user_data:', localStorage.getItem('user_data'));
    console.log('Todas las keys:', Object.keys(localStorage));

    // Tambi√©n verificar el estado del servicio
    const debugInfo = this.userStateService.getDebugInfo();
    console.log('üîç Estado del UserStateService:', debugInfo);

    // USAR ALERT PARA MOSTRAR LA INFORMACI√ìN
    const token = localStorage.getItem('access_token');
    const userData = localStorage.getItem('user_data');
    const keys = Object.keys(localStorage);

    let mensaje = 'üîç LOCALSTORAGE:\n\n';
    mensaje += `Keys: ${keys.join(', ')}\n\n`;
    mensaje += `Token existe: ${!!token}\n`;
    mensaje += `User data existe: ${!!userData}\n\n`;

    if (token) {
      mensaje += `Token (50 chars): ${token.substring(0, 50)}...\n\n`;
    }

    if (userData) {
      mensaje += `User data: ${userData}\n`;
    } else {
      mensaje += 'User data: NO EXISTE\n';
    }

    alert(mensaje);
  }

  // M√âTODO TEMPORAL PARA PROBAR LOGIN DIRECTO
  async probarLoginDirecto(): Promise<void> {
    console.log('üß™ === PRUEBA DE LOGIN DIRECTO ===');

    try {
      // Intentar login directo con fetch
      const loginData = {
        username: 'tu_username_aqui', // üëà CAMBIAR POR TU USERNAME REAL
        password: 'tu_password_aqui'  // üëà CAMBIAR POR TU PASSWORD REAL
      };

      console.log('üì§ Enviando request a:', 'http://localhost:3000/auth/login');
      console.log('üì¶ Payload:', { username: loginData.username, password: '***' });

      const response = await fetch('http://localhost:3000/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(loginData)
      });

      console.log('üì° Status:', response.status);
      console.log('üìä Status text:', response.statusText);

      if (!response.ok) {
        console.error('‚ùå Response no OK:', response.statusText);
        const errorText = await response.text();
        console.error('üìÑ Error body:', errorText);
        return;
      }

      const data = await response.json();
      console.log('‚úÖ Response completa:', data);
      console.log('üîë Token existe:', !!data.access_token);
      console.log('üë§ User existe:', !!data.user);

      if (data.user) {
        console.log('üë§ Estructura del usuario:', Object.keys(data.user));
        console.log('üìã Datos del usuario:', data.user);
      }

    } catch (error) {
      console.error('‚ùå Error en prueba directa:', error);
    }
  }

  // M√âTODO PARA DECODIFICAR JWT Y VER SU CONTENIDO
  decodificarToken(): void {
    console.log('üîê === DECODIFICACI√ìN DE TOKEN JWT ===');

    const token = localStorage.getItem('access_token');
    if (!token) {
      console.log('‚ùå No hay token en localStorage');
      alert('‚ùå No hay token en localStorage');
      return;
    }

    try {
      // Decodificar JWT (solo la parte del payload)
      const parts = token.split('.');
      if (parts.length !== 3) {
        console.error('‚ùå Token JWT inv√°lido - no tiene 3 partes');
        alert('‚ùå Token JWT inv√°lido - no tiene 3 partes');
        return;
      }

      // Decodificar el payload (segunda parte)
      const payload = parts[1];
      const decoded = JSON.parse(atob(payload));

      console.log('üîç Token completo:', token);
      console.log('üì¶ Payload decodificado:', decoded);
      console.log('üë§ Usuario ID:', decoded.sub);
      console.log('üìß Username:', decoded.username);
      console.log('‚è∞ Issued at:', new Date(decoded.iat * 1000));
      console.log('‚è±Ô∏è Expires at:', new Date(decoded.exp * 1000));

      // MOSTRAR CON ALERT
      let mensaje = 'üîê TOKEN DECODIFICADO:\n\n';
      mensaje += `Usuario ID: ${decoded.sub}\n`;
      mensaje += `Username: ${decoded.username}\n`;
      mensaje += `Creado: ${new Date(decoded.iat * 1000).toLocaleString()}\n`;
      mensaje += `Expira: ${new Date(decoded.exp * 1000).toLocaleString()}\n\n`;
      mensaje += `Payload completo:\n${JSON.stringify(decoded, null, 2)}`;

      alert(mensaje);

    } catch (error) {
      console.error('‚ùå Error al decodificar token:', error);
      alert('‚ùå Error al decodificar token: ' + error);
    }
  }

  // M√âTODO SIMPLE PARA PROBAR FUNCIONALIDAD
  testSimple(): void {
    alert('‚úÖ Los m√©todos S√ç funcionan!');
    console.log('‚úÖ testSimple() ejecutado correctamente');

    // Mostrar informaci√≥n b√°sica
    const token = localStorage.getItem('access_token');
    const userData = localStorage.getItem('user_data');

    console.log('üîç ESTADO ACTUAL:');
    console.log('Token existe:', !!token);
    console.log('User data existe:', !!userData);
    console.log('Token (primeros 50 chars):', token ? token.substring(0, 50) + '...' : 'NO EXISTE');
    console.log('User data:', userData || 'NO EXISTE');
  }

  // üéØ M√âTODO PARA VERIFICAR ESTADO POST-LOGIN
  verificarEstadoPostLogin(): void {
    console.log('\nüéØ === VERIFICACI√ìN COMPLETA POST-LOGIN ===\n');

    // 1. Verificar LocalStorage
    const token = localStorage.getItem('access_token');
    const userData = localStorage.getItem('user_data');

    console.log('üìä LOCALSTORAGE:');
    console.log('‚úÖ Token existe:', !!token);
    console.log('‚úÖ User data existe:', !!userData);

    if (userData) {
      try {
        const parsedUserData = JSON.parse(userData);
        console.log('üë§ Datos de usuario parseados:', parsedUserData);
      } catch (error) {
        console.error('‚ùå Error al parsear user data:', error);
      }
    }

    // 2. Verificar UserStateService
    const usuario = this.userStateService.getUsuarioActual();
    console.log('\nüîß USERSTATE SERVICE:');
    console.log('‚úÖ Usuario en servicio:', !!usuario);

    if (usuario) {
      console.log('üë§ Usuario completo:', usuario);
      console.log('üìß Correo:', usuario.correo);
      console.log('üë§ Nombre completo:', `${usuario.nombre} ${usuario.apellido}`);
      console.log('üé≠ Rol ID:', usuario.idrol);
      console.log('üè´ Colegio ID:', usuario.idcolegio);
      console.log('‚úÖ Estado:', usuario.estado);
    }

    // 3. Verificar estado de la UI
    console.log('\nüñ•Ô∏è ESTADO DE LA UI:');
    console.log('üë§ Perfil usuario (variable):', this.perfilUsuario);
    console.log('üë§ Nombre mostrado:', this.nombreUsuario);
    console.log('üé≠ Rol mostrado:', this.rolUsuario);

    // 4. Resumen para el usuario
    let resumen = 'üéØ VERIFICACI√ìN POST-LOGIN:\n\n';
    resumen += `‚úÖ Token en LocalStorage: ${!!token}\n`;
    resumen += `‚úÖ User data en LocalStorage: ${!!userData}\n`;
    resumen += `‚úÖ Usuario en UserStateService: ${!!usuario}\n`;
    resumen += `‚úÖ UI actualizada: ${!!this.perfilUsuario}\n\n`;

    if (usuario) {
      resumen += `DATOS DEL USUARIO:\n`;
      resumen += `‚Ä¢ Nombre: ${usuario.nombre} ${usuario.apellido}\n`;
      resumen += `‚Ä¢ Email: ${usuario.correo}\n`;
      resumen += `‚Ä¢ Rol ID: ${usuario.idrol}\n`;
      resumen += `‚Ä¢ Estado: ${usuario.estado}\n`;
    }

    resumen += '\nRevisa la consola para m√°s detalles.';
    alert(resumen);

    console.log('\nüéØ === FIN DE VERIFICACI√ìN ===\n');
  }
}
